<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ambient Weather – Daily Avg Temp, Cumulative GDD, Daily Rain & Bud Break</title>
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- sql.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
  <style>
    /* Remove default margins/padding for full-screen usage */
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    /* Toggle buttons for slide-out panels */
    #toggleLeftPanel, #toggleRightPanel {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      background: #007acc;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
    }
    #toggleLeftPanel {
      left: 0;
    }
    #toggleRightPanel {
      right: 0;
    }
    /* Auto Refresh Toggle Control */
    #autoRefreshControl {
      text-align: center;
      margin: 10px 0;
    }
    /* Flex container for panels and chart */
    .flex-container {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      width: 100%;
      box-sizing: border-box;
      transition: margin 0.3s ease;
    }
    /* Left slide-out panel (months) */
    #leftPanel {
      width: 150px;
      transition: width 0.3s ease;
      background: #e0e0e0;
      box-sizing: border-box;
      padding: 10px;
      text-align: left;
    }
    #leftPanel.hidden {
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    /* Right slide-out panel (years) */
    #rightPanel {
      width: 150px;
      transition: width 0.3s ease;
      background: #e0e0e0;
      box-sizing: border-box;
      padding: 10px;
      text-align: right;
    }
    #rightPanel.hidden {
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    /* Chart container fills remaining space */
    #chartContainer {
      flex: 1;
      padding: 10px;
      box-sizing: border-box;
      height: 80vh;  /* 80% of viewport height */
    }
    /* Ensure the canvas fills its container */
    canvas {
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      width: 100% !important;
      height: 100% !important;
      display: block;
    }
    /* Ensure the checkboxes are stacked */
    #monthControls label, #yearControls label {
      display: block;
      margin: 5px 0;
    }
    /* Custom legend container styling */
    #legendContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 5px;
      box-sizing: border-box;
    }
    #legendContainer .legend-item {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border: 1px solid;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 2px;
    }
  </style>
</head>
<body>
  <h1>Robert Clay Vineyards</h1>
  <h2>GDD 50 Data Dashboard</h2>
  <h3>
    Data Sources:
    <a href="https://ambientweather.net/">ambientweather.net</a> &amp;
    <a href="https://open-meteo.com/en/docs/historical-weather-api">Open-Meteo</a>
  </h3>
  <!-- Toggle buttons for slide-out panels -->
  <button id="toggleLeftPanel">Toggle Months</button>
  <button id="toggleRightPanel">Toggle Years</button>
  <!-- Auto Refresh Toggle -->
  <div id="autoRefreshControl">
    <label>
      <input type="checkbox" id="autoRefreshCheckbox" checked>
      Auto Refresh
    </label>
  </div>

  <div class="container">
    <div class="flex-container">
      <!-- Left slide-out panel for Month Filters -->
      <div id="leftPanel">
        <h3>Select Months</h3>
        <div id="monthControls">
          <label><input type="checkbox" name="month" value="1" checked> January</label>
          <label><input type="checkbox" name="month" value="2" checked> February</label>
          <label><input type="checkbox" name="month" value="3" checked> March</label>
          <label><input type="checkbox" name="month" value="4" checked> April</label>
          <label><input type="checkbox" name="month" value="5" checked> May</label>
          <label><input type="checkbox" name="month" value="6"> June</label>
          <label><input type="checkbox" name="month" value="7"> July</label>
          <label><input type="checkbox" name="month" value="8"> August</label>
          <label><input type="checkbox" name="month" value="9"> September</label>
          <label><input type="checkbox" name="month" value="10"> October</label>
          <label><input type="checkbox" name="month" value="11"> November</label>
          <label><input type="checkbox" name="month" value="12"> December</label>
        </div>
      </div>
      <!-- Chart Container -->
      <div id="chartContainer">
        <h2>Daily Avg Temp, Cumulative GDD, Daily Rain & Bud Break</h2>
        <canvas id="dailyChart"></canvas>
        <!-- Custom legend will be generated here -->
        <div id="legendContainer"></div>
      </div>
      <!-- Right slide-out panel for Year Filters -->
      <div id="rightPanel">
        <h3>Select Years</h3>
        <div id="yearControls">
          <!-- Dynamically populated once after DB load -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global configuration (for demo)
    const DEBUG = true;
    const DB_FILENAME = "ambient_weather.sqlite";

    // --- Helper Functions for Logging ---
    function log(message) {
      const now = new Date().toISOString().replace("T", " ").replace("Z", "");
      console.log("[" + now + "] " + message);
    }
    function log_debug(message) {
      if (DEBUG) {
        log("[DEBUG] " + message);
      }
    }

    // Global auto-refresh settings
    let autoRefresh = true;
    let refreshIntervalId = null;
    // Set the auto-refresh period (milliseconds)
    const AUTO_REFRESH_PERIOD = 60000; // 60 seconds

    // Sample event flags for years (modify as needed)
    const yearEvents = {
      "2008": ["Solar Min", "La Niña"],
      "2009": ["La Niña"],
      "2010": ["La Niña"],
      "2011": ["La Niña"],
      "2012": ["La Niña"],
      "2013": [],
      "2014": ["Solar Max"],
      "2015": ["El Niño"],
      "2016": ["El Niño"],
      "2017": ["La Niña"],
      "2018": [],
      "2019": ["Solar Min"],
      "2020": ["La Niña"],
      "2021": ["La Niña"],
      "2022": [],
      "2023": [],
      "2024": []
    };

    // Custom Plugin: horizontalLinePlugin draws horizontal lines at 32°F, 50°F, and 89°F.
    const horizontalLinePlugin = {
      id: 'horizontalLinePlugin',
      afterDraw(chart, args, options) {
        const { ctx, chartArea: { left, right }, scales: { y } } = chart;
        if (!y) return;
        function drawLine(yValue, color, text) {
          const yPixel = y.getPixelForValue(yValue);
          ctx.save();
          ctx.beginPath();
          ctx.setLineDash([6, 6]);
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.moveTo(left, yPixel);
          ctx.lineTo(right, yPixel);
          ctx.stroke();
          ctx.restore();
          ctx.fillStyle = color;
          ctx.font = '12px Arial';
          ctx.fillText(text, left + 5, yPixel - 5);
        }
        drawLine(32, 'green', 'Freeze (32°F)');
        drawLine(50, 'blue', 'Base Temp (50°F)');
        drawLine(89, 'red', 'Ceiling Temp (89°F)');
      }
    };
    Chart.register(horizontalLinePlugin);

    let db = null;
    let dailyChart;
    let SQL;

    // --- Auto-Refresh Control Functions ---
    function startAutoRefresh() {
      if (!refreshIntervalId) {
        refreshIntervalId = setInterval(loadAndPlotData, AUTO_REFRESH_PERIOD);
        log("Auto Refresh started (every " + (AUTO_REFRESH_PERIOD/1000) + " seconds).");
      }
    }
    function stopAutoRefresh() {
      if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
        log("Auto Refresh stopped.");
      }
    }

    // --- Initialize sql.js and load the database ---
    initSqlJs({
      locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
    }).then(function(SQLLib) {
      SQL = SQLLib;
      return fetch(DB_FILENAME);
    }).then(response => response.arrayBuffer())
      .then(buffer => {
        db = new SQL.Database(new Uint8Array(buffer));
        log("Database loaded successfully.");
        // Populate the year checkboxes once (do not refresh these on every auto refresh)
        populateYearControls();
        loadAndPlotData();
        startAutoRefresh();
        // Attach event listeners to filters.
        document.querySelectorAll("input[name='year']").forEach(cb => {
          cb.addEventListener("change", loadAndPlotData);
        });
        document.querySelectorAll("input[name='month']").forEach(cb => {
          cb.addEventListener("change", loadAndPlotData);
        });
        // Attach event listener to auto refresh toggle.
        document.getElementById("autoRefreshCheckbox").addEventListener("change", function() {
          autoRefresh = this.checked;
          log("Auto Refresh is now " + (autoRefresh ? "enabled" : "disabled"));
          if (autoRefresh) {
            startAutoRefresh();
          } else {
            stopAutoRefresh();
          }
        });
      }).catch(err => console.error("Error initializing database:", err));

    // --- Populate Year Controls Dynamically with Event Flags ---
    function populateYearControls() {
      const res = db.exec("SELECT DISTINCT substr(date, 1, 4) as year FROM readings ORDER BY year ASC;");
      const yearControls = document.getElementById("yearControls");
      yearControls.innerHTML = "";
      if (res.length > 0) {
        const years = res[0].values.map(row => row[0]);
        years.forEach(year => {
          let labelText = year;
          if (yearEvents.hasOwnProperty(year) && yearEvents[year].length > 0) {
            labelText += " (" + yearEvents[year].join(", ") + ")";
          }
          const label = document.createElement("label");
          label.innerHTML = `<input type="checkbox" name="year" value="${year}" checked> ${labelText}`;
          yearControls.appendChild(label);
        });
      }
    }

    // --- Query Data for a Specific Year and Selected Months ---
    function queryDataByYearAndMonths(year, months) {
      const monthList = months.map(m => m).join(",");
      const sqlQuery = `
        SELECT substr(date, 6, 5) AS day_key,
               AVG(tempf) AS avgTempF,
               MAX(gdd) AS maxCumGDD,
               MAX(dailyrainin) AS rainTotal
        FROM readings
        WHERE substr(date, 1, 4) = '${year}'
          AND cast(substr(date, 6, 2) as integer) IN (${monthList})
        GROUP BY day_key
        ORDER BY day_key ASC;
      `;
      const stmt = db.prepare(sqlQuery);
      const results = [];
      while (stmt.step()) {
        results.push(stmt.getAsObject());
      }
      stmt.free();
      return results;
    }

    // --- Process Queried Data ---
    function processYearlyData(rows) {
      const data = {};
      rows.forEach(r => {
        data[r.day_key] = {
          avgTempF: parseFloat(r.avgTempF),
          maxCumGDD: parseFloat(r.maxCumGDD),
          rainTotal: parseFloat(r.rainTotal)
        };
      });
      return data;
    }

    // --- Align Data to a Common X-axis ---
    function alignData(commonLabels, dataByDay, field) {
      return commonLabels.map(label => dataByDay[label] ? dataByDay[label][field] : null);
    }

    // --- Compute Bud Break Points Grouped by Variety ---
    function computeBudBreakPoints(selectedYears, commonLabels, yearlyData) {
      const result = db.exec("SELECT variety, heat_summation FROM grapevine_gdd ORDER BY variety");
      if (result.length === 0) return [];
      const grapeData = result[0].values;
      const budBreakByVariety = {};
      grapeData.forEach(row => {
        const variety = row[0];
        budBreakByVariety[variety] = [];
      });
      selectedYears.forEach(year => {
        const dataForYear = yearlyData[year];
        grapeData.forEach(row => {
          const variety = row[0];
          const threshold = row[1];
          for (let i = 0; i < commonLabels.length; i++) {
            const dayKey = commonLabels[i];
            const record = dataForYear[dayKey];
            if (record && record.maxCumGDD >= threshold) {
              budBreakByVariety[variety].push({ x: dayKey, y: record.maxCumGDD, year: year });
              break; // One bud break point per year per variety.
            }
          }
        });
      });
      const scatterDatasets = [];
      Object.keys(budBreakByVariety).forEach(variety => {
        const points = budBreakByVariety[variety];
        if (points.length > 0) {
          scatterDatasets.push({
            label: variety,
            data: points,
            borderColor: getColorForVariety(variety),
            backgroundColor: getColorForVariety(variety),
            pointRadius: 6,
            type: 'scatter',
            showLine: false,
            order: 2,
            yAxisID: 'y1'
          });
        }
      });
      return scatterDatasets;
    }

    // --- Function to Get Color for Variety ---
    function getColorForVariety(variety) {
      const grapeColors = {
        "Chardonnay": "rgb(255,140,0)",
        "Sauvignon Blanc": "rgb(255,215,0)",
        "Riesling": "rgb(255,69,0)",
        "Pinot Gris": "rgb(30,144,255)",
        "Semillon": "rgb(255,99,71)",
        "Cabernet Sauvignon": "rgb(139,0,0)",
        "Merlot": "rgb(220,20,60)",
        "Pinot Noir": "rgb(128,0,0)",
        "Syrah": "rgb(178,34,34)",
        "Zinfandel": "rgb(138,43,226)",
        "Sangiovese": "rgb(165,42,42)",
        "Tempranillo": "rgb(199,21,133)",
        "Malbec": "rgb(128,0,128)",
        "Grenache": "rgb(255,105,180)",
        "Nebbiolo": "rgb(75,0,130)"
      };
      if (grapeColors[variety]) {
        return grapeColors[variety];
      }
      const fallbackColors = [
        "rgb(255,0,0)",
        "rgb(0,255,0)",
        "rgb(0,0,255)",
        "rgb(255,255,0)",
        "rgb(255,0,255)",
        "rgb(0,255,255)"
      ];
      return fallbackColors[Math.floor(Math.random() * fallbackColors.length)];
    }

    // --- Random Color Generator (optional) ---
    function randomColor() {
      const r = Math.floor(Math.random() * 156) + 100;
      const g = Math.floor(Math.random() * 156) + 100;
      const b = Math.floor(Math.random() * 156) + 100;
      return `rgb(${r},${g},${b})`;
    }

    // --- Generate Custom Legend ---
    function generateCustomLegend(chart) {
      const legendContainer = document.getElementById('legendContainer');
      legendContainer.innerHTML = '';
      const datasets = chart.data.datasets;
      const legendList = document.createElement('div');
      legendList.style.display = 'flex';
      legendList.style.flexWrap = 'wrap';
      legendList.style.justifyContent = 'center';
      legendList.style.gap = '8px';
      datasets.forEach((ds, index) => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        let markerHTML = "";
        if (ds.type === "scatter") {
          markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:${ds.borderColor}; border-radius:50%; margin-right:5px;"></span>`;
        } else if (ds.type === "line") {
          const dash = ds.borderDash && ds.borderDash.length > 0 ? "dashed" : "solid";
          markerHTML = `<span style="display:inline-block; width:20px; border-bottom:2px ${dash} ${ds.borderColor}; margin-right:5px;"></span>`;
        } else if (ds.type === "bar") {
          markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:${ds.backgroundColor}; margin-right:5px;"></span>`;
        }
        legendItem.innerHTML = markerHTML + ds.label;
        legendItem.onclick = function() {
          chart.toggleDataVisibility(index);
          chart.update();
        };
        legendList.appendChild(legendItem);
      });
      legendContainer.appendChild(legendList);
    }

    // --- Load and Plot Data Automatically (Overlay Years) ---
    function loadAndPlotData() {
      if (!db) return;
      const yearCheckboxes = document.querySelectorAll("input[name='year']:checked");
      const selectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
      const monthCheckboxes = document.querySelectorAll("input[name='month']:checked");
      const selectedMonths = Array.from(monthCheckboxes).map(cb => parseInt(cb.value));
      if (selectedYears.length === 0 || selectedMonths.length === 0) return;

      let commonLabelsSet = new Set();
      let yearlyData = {};
      selectedYears.forEach(year => {
        const rows = queryDataByYearAndMonths(year, selectedMonths);
        const data = processYearlyData(rows);
        yearlyData[year] = data;
        Object.keys(data).forEach(day_key => commonLabelsSet.add(day_key));
      });
      const commonLabels = Array.from(commonLabelsSet).sort();

      let datasets = [];
      selectedYears.forEach(year => {
        const dataForYear = yearlyData[year];
        const tempData = alignData(commonLabels, dataForYear, "avgTempF");
        const gddData = alignData(commonLabels, dataForYear, "maxCumGDD");
        const rainData = alignData(commonLabels, dataForYear, "rainTotal");
        const color1 = randomColor();
        const color2 = randomColor();
        const color3 = randomColor();
        datasets.push({
          label: "Daily Avg Temp (°F) - " + year,
          data: tempData,
          borderColor: color1,
          backgroundColor: 'transparent',
          yAxisID: "y",
          tension: 0.4,
          pointRadius: 3,
          fill: false,
          type: 'line'
        });
        datasets.push({
          label: "Cumulative GDD - " + year,
          data: gddData,
          borderColor: color2,
          backgroundColor: 'transparent',
          yAxisID: "y1",
          tension: 0.4,
          pointRadius: 2,
          borderDash: [10, 5],
          fill: false,
          type: 'line'
        });
        datasets.push({
          label: "Daily Rain Total (in) - " + year,
          data: rainData,
          backgroundColor: color3,
          yAxisID: "y2",
          type: 'bar'
        });
      });

      // Compute bud break points (one dataset per grape variety across selected years)
      const budBreakDatasets = computeBudBreakPoints(selectedYears, commonLabels, yearlyData);
      datasets = datasets.concat(budBreakDatasets);

      if (dailyChart) dailyChart.destroy();
      const ctx = document.getElementById('dailyChart').getContext('2d');
      dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: commonLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "Daily Avg Temp, Cumulative GDD, Daily Rain Totals & Bud Break (Overlayed by Year)"
            },
            legend: {
              display: false  // We are using a custom legend below.
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Month-Day"
              }
            },
            y: {
              position: "left",
              title: { display: true, text: "Temperature (°F)" }
            },
            y1: {
              position: "right",
              title: { display: true, text: "Cumulative GDD" },
              grid: { drawOnChartArea: false }
            },
            y2: {
              position: "right",
              title: { display: true, text: "Rain Total (in)" },
              grid: { drawOnChartArea: false },
              offset: true
            }
          }
        }
      });
      generateCustomLegend(dailyChart);
    }

    // --- Slide-Out Panel Toggle Logic ---
    document.getElementById("toggleLeftPanel").addEventListener("click", function() {
      const leftPanel = document.getElementById("leftPanel");
      leftPanel.classList.toggle("hidden");
      setTimeout(() => window.dispatchEvent(new Event('resize')), 350);
    });
    document.getElementById("toggleRightPanel").addEventListener("click", function() {
      const rightPanel = document.getElementById("rightPanel");
      rightPanel.classList.toggle("hidden");
      setTimeout(() => window.dispatchEvent(new Event('resize')), 350);
    });
    window.addEventListener("resize", function() {
      if (dailyChart) dailyChart.resize();
    });

    // Initial load (filters already exist from initial page load)
    window.onload = loadAndPlotData;
  </script>
</body>
</html>
