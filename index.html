<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ambient Weather – Daily Avg Temp, Cumulative GDD, Daily Rain & Bud Break</title>
    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- sql.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <style>
        /* Remove default margins/padding for full-screen usage */
        body {
            font-family: Arial, sans-serif;
            background: #fafafa;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        h1, h2, h3 {
            text-align: center;
            margin: 10px 0;
        }
        /* Toggle buttons for slide-out panels */
        #toggleLeftPanel, #toggleRightPanel {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
        }
        #toggleLeftPanel {
            left: 0;
        }
        #toggleRightPanel {
            right: 0;
        }
        /* Auto Refresh Toggle Control */
        #autoRefreshControl {
            text-align: center;
            margin: 10px 0;
        }
        /* Flex container for panels and chart */
        .flex-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            width: 100%;
            box-sizing: border-box;
            transition: margin 0.3s ease;
        }
        /* Left slide-out panel (months) */
        #leftPanel {
            width: 150px;
            transition: width 0.3s ease;
            background: #e0e0e0;
            box-sizing: border-box;
            padding: 10px;
            text-align: left;
        }
        #leftPanel.hidden {
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        /* Right slide-out panel (years) */
        #rightPanel {
            width: 150px;
            transition: width 0.3s ease;
            background: #e0e0e0;
            box-sizing: border-box;
            padding: 10px;
            text-align: right;
        }
        #rightPanel.hidden {
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        /* Chart container fills remaining space */
        #chartContainer {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            height: 80vh;  /* 80% of viewport height */
        }
        /* Ensure the canvas fills its container */
        canvas {
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        /* Ensure the checkboxes are stacked */
        #monthControls label, #yearControls label {
            display: block;
            margin: 5px 0;
        }
        /* Custom legend container styling for the bottom legend */
        #legendContainer {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 15px;
            padding: 5px;
            box-sizing: border-box;
        }
        /* Updated legend item style for bottom legend (no button look) */
        #legendContainer .legend-item {
            display: inline-flex;
            align-items: center;
            padding: 2px 4px;
            margin: 2px;
            font-size: 0.9em;
            color: #333;
            background: transparent;
            border: none;
            border-radius: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Robert Clay Vineyards</h1>
    <h2>GDD 50 Data Dashboard</h2>
    <h3>
        Data Sources:
        <a href="https://ambientweather.net/">ambientweather.net</a> &amp;
        <a href="https://open-meteo.com/en/docs/historical-weather-api">Open-Meteo</a>
    </h3>
    <!-- Toggle buttons for slide-out panels -->
    <button id="toggleLeftPanel">Toggle Months</button>
    <button id="toggleRightPanel">Toggle Years</button>
    <!-- Auto Refresh Toggle -->
    <div id="autoRefreshControl">
        <label>
            <input type="checkbox" id="autoRefreshCheckbox" checked>
            Auto Refresh
        </label>
    </div>

    <div class="container">
        <div class="flex-container">
            <!-- Left slide-out panel for Month Filters -->
            <div id="leftPanel">
                <h3>Select Months</h3>
                <div id="monthControls">
                    <label><input type="checkbox" id="allMonths" checked> All Months</label>
                    <label><input type="checkbox" name="month" value="1" checked> January</label>
                    <label><input type="checkbox" name="month" value="2" checked> February</label>
                    <label><input type="checkbox" name="month" value="3" checked> March</label>
                    <label><input type="checkbox" name="month" value="4" checked> April</label>
                    <label><input type="checkbox" name="month" value="5" checked> May</label>
                    <label><input type="checkbox" name="month" value="6" checked> June</label>
                    <label><input type="checkbox" name="month" value="7" checked> July</label>
                    <label><input type="checkbox" name="month" value="8" checked> August</label>
                    <label><input type="checkbox" name="month" value="9" checked> September</label>
                    <label><input type="checkbox" name="month" value="10" checked> October</label>
                    <label><input type="checkbox" name="month" value="11" checked> November</label>
                    <label><input type="checkbox" name="month" value="12" checked> December</label>
                </div>
                <!-- Container for Grape Varietal legend items (left justified) -->
                <div id="grapeVarietalLegend"></div>
            </div>
            <!-- Chart Container -->
            <div id="chartContainer">
                <h2>Daily Avg Temp, Cumulative GDD, Daily Rain & Bud Break</h2>
                <canvas id="dailyChart"></canvas>
                <!-- Bottom legend container for non–grape–varietal groups -->
                <div id="legendContainer"></div>
            </div>
            <!-- Right slide-out panel for Year Filters -->
            <div id="rightPanel">
                <h3>Select Years</h3>
                <div id="yearControls">
                    <!-- Dynamic year checkboxes will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global auto-refresh settings
        let autoRefresh = true;
        let refreshIntervalId = null;
        const AUTO_REFRESH_PERIOD = 60000; // 60 seconds

        // Sample event flags for years (modify as needed)
        const yearEvents = {
            "2008": ["La Niña", "Solar Min [2]"],
            "2009": ["La Niña", "Solar Min [3]"],
            "2010": ["La Niña", "Solar Min Transitioning to Max [4]"],
            "2011": ["La Niña", "Solar Transition [5]"],
            "2012": ["La Niña", "Solar Transition [6]"],
            "2013": ["Neutral", "Solar Max [7]"],
            "2014": ["Neutral", "Solar Max [8]"],
            "2015": ["El Niño", "Solar Max [7]"],
            "2016": ["El Niño", "Solar Transition [6]"],
            "2017": ["La Niña", "Solar Transition [5]"],
            "2018": ["Neutral", "Solar Transition [4]"],
            "2019": ["Weak El Niño", "Solar Min [3]"],
            "2020": ["Neutral", "Solar Min [2]"],
            "2021": ["La Niña", "Solar Min [3]"],
            "2022": ["Moderate La Niña", "Solar Transition [4]"],
            "2023": ["El Niño", "Solar Transition [5]"],
            "2024": ["Transition from El Niño to Neutral", "Solar Transition [6]"],
            "2025": ["Neutral", "Solar Max [7]"]
        };

        // Custom Plugin: horizontalLinePlugin draws horizontal lines at 32°F, 50°F, and 89°F.
        const horizontalLinePlugin = {
            id: 'horizontalLinePlugin',
            afterDraw(chart, args, options) {
                const { ctx, chartArea: { left, right }, scales: { y } } = chart;
                if (!y) return;
                function drawLine(yValue, color, text) {
                    const yPixel = y.getPixelForValue(yValue);
                    ctx.save();
                    ctx.beginPath();
                    ctx.setLineDash([6, 6]);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.moveTo(left, yPixel);
                    ctx.lineTo(right, yPixel);
                    ctx.stroke();
                    ctx.restore();
                    ctx.fillStyle = color;
                    ctx.font = '12px Arial';
                    ctx.fillText(text, left + 5, yPixel - 5);
                }
                drawLine(32, 'green', 'Freeze (32°F)');
                drawLine(50, 'blue', 'Base Temp (50°F)');
                drawLine(89, 'red', 'Ceiling Temp (89°F)');
            }
        };
        Chart.register(horizontalLinePlugin);

        let db = null;
        let dailyChart;
        let SQL;

        // --- Helper Functions for Logging ---
        function log(message) {
            const now = new Date().toISOString().replace("T", " ").replace("Z", "");
            console.log("[" + now + "] " + message);
        }
        function log_debug(message) {
            if (DEBUG) {
                log("[DEBUG] " + message);
            }
        }

        // Global configuration (for demo)
        let DEBUG = true;
        let DB_FILENAME = "ambient_weather.sqlite";

        // --- Save and Load Filter Settings from localStorage ---
        function saveFilterSettings() {
            const monthCheckboxes = document.querySelectorAll("input[name='month']");
            const selectedMonths = Array.from(monthCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            localStorage.setItem("selectedMonths", JSON.stringify(selectedMonths));

            const yearCheckboxes = document.querySelectorAll("input[name='year']");
            const selectedYears = Array.from(yearCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            localStorage.setItem("selectedYears", JSON.stringify(selectedYears));
        }

        function loadFilterSettings() {
            const storedMonths = localStorage.getItem("selectedMonths");
            if (storedMonths) {
                const selectedMonths = JSON.parse(storedMonths);
                document.querySelectorAll("input[name='month']").forEach(cb => {
                    cb.checked = selectedMonths.includes(cb.value);
                });
                const allChecked = Array.from(document.querySelectorAll("input[name='month']")).every(cb => cb.checked);
                const allMonthsCb = document.getElementById("allMonths");
                if (allMonthsCb) allMonthsCb.checked = allChecked;
            }
            const storedYears = localStorage.getItem("selectedYears");
            if (storedYears) {
                const selectedYears = JSON.parse(storedYears);
                document.querySelectorAll("input[name='year']").forEach(cb => {
                    cb.checked = selectedYears.includes(cb.value);
                });
                const allChecked = Array.from(document.querySelectorAll("input[name='year']")).every(cb => cb.checked);
                const allYearsCb = document.getElementById("allYears");
                if (allYearsCb) allYearsCb.checked = allChecked;
            }
        }

        // --- Auto-Refresh Control Functions ---
        function startAutoRefresh() {
            if (!refreshIntervalId) {
                refreshIntervalId = setInterval(loadAndPlotData, AUTO_REFRESH_PERIOD);
                log("Auto Refresh started (every " + (AUTO_REFRESH_PERIOD / 1000) + " seconds).");
            }
        }

        function stopAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
                log("Auto Refresh stopped.");
            }
        }

        // --- Initialize sql.js and load the database ---
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
        }).then(function (SQLLib) {
            SQL = SQLLib;
            return fetch(DB_FILENAME);
        }).then(response => response.arrayBuffer())
            .then(buffer => {
                db = new SQL.Database(new Uint8Array(buffer));
                log("Database loaded successfully.");
                populateYearControls();
                loadFilterSettings();
                loadAndPlotData();
                startAutoRefresh();

                // Attach event listeners to filters.
                document.querySelectorAll("input[name='year']").forEach(cb => {
                    cb.addEventListener("change", function () {
                        let allChecked = true;
                        document.querySelectorAll("input[name='year']").forEach(box => {
                            if (!box.checked) { allChecked = false; }
                        });
                        const allYearsCb = document.getElementById("allYears");
                        if (allYearsCb) allYearsCb.checked = allChecked;
                        saveFilterSettings();
                        loadAndPlotData();
                    });
                });
                const allYearsCb = document.getElementById("allYears");
                if (allYearsCb) {
                    allYearsCb.addEventListener("change", function () {
                        const newState = this.checked;
                        document.querySelectorAll("input[name='year']").forEach(cb => {
                            cb.checked = newState;
                        });
                        saveFilterSettings();
                        loadAndPlotData();
                    });
                }
                document.querySelectorAll("input[name='month']").forEach(cb => {
                    cb.addEventListener("change", function () {
                        let allChecked = true;
                        document.querySelectorAll("input[name='month']").forEach(box => {
                            if (!box.checked) { allChecked = false; }
                        });
                        const allMonthsCb = document.getElementById("allMonths");
                        if (allMonthsCb) allMonthsCb.checked = allChecked;
                        saveFilterSettings();
                        loadAndPlotData();
                    });
                });
                const allMonthsCb = document.getElementById("allMonths");
                if (allMonthsCb) {
                    allMonthsCb.addEventListener("change", function () {
                        const newState = this.checked;
                        document.querySelectorAll("input[name='month']").forEach(cb => {
                            cb.checked = newState;
                        });
                        saveFilterSettings();
                        loadAndPlotData();
                    });
                }
                document.getElementById("autoRefreshCheckbox").addEventListener("change", function () {
                    autoRefresh = this.checked;
                    log("Auto Refresh is now " + (autoRefresh ? "enabled" : "disabled"));
                    if (autoRefresh) {
                        startAutoRefresh();
                    } else {
                        stopAutoRefresh();
                    }
                });
            }).catch(err => console.error("Error initializing database:", err));

        // --- Populate Year Controls Dynamically with Event Flags ---
        function populateYearControls() {
            const res = db.exec("SELECT DISTINCT substr(date, 1, 4) as year FROM readings ORDER BY year ASC;");
            const yearControls = document.getElementById("yearControls");
            yearControls.innerHTML = "";
            const allYearsLabel = document.createElement("label");
            allYearsLabel.innerHTML = `<input type="checkbox" id="allYears" checked> All Years`;
            yearControls.appendChild(allYearsLabel);
            if (res.length > 0) {
                const years = res[0].values.map(row => row[0]);
                years.forEach(year => {
                    let labelText = year;
                    if (yearEvents.hasOwnProperty(year) && yearEvents[year].length > 0) {
                        labelText += " (" + yearEvents[year].join(", ") + ")";
                    }
                    const label = document.createElement("label");
                    label.innerHTML = `<input type="checkbox" name="year" value="${year}" checked> ${labelText}`;
                    yearControls.appendChild(label);
                });
            }
        }

        // --- Query Data for a Specific Year and Selected Months ---
        function queryDataByYearAndMonths(year, months) {
            const monthList = months.map(m => m).join(",");
            const sqlQuery = `
                SELECT substr(date, 6, 5) AS day_key,
                       MIN(tempf)         AS minTempF,
                       MAX(tempf)         AS maxTempF,
                       AVG(tempf)         AS avgTempF,
                       MAX(gdd)           AS maxCumGDD,
                       MAX(dailyrainin)   AS rainTotal
                FROM readings
                WHERE substr(date, 1, 4) = '${year}'
                  AND cast(substr(date, 6, 2) as integer) IN (${monthList})
                GROUP BY day_key
                ORDER BY day_key ASC;
            `;
            const stmt = db.prepare(sqlQuery);
            const results = [];
            while (stmt.step()) {
                results.push(stmt.getAsObject());
            }
            stmt.free();
            return results;
        }

        // --- Query Sunspots Data for a Specific Year and Selected Months ---
        function querySunspotsDataByYearAndMonths(year, months) {
            const monthList = months.join(",");
            const sqlQuery = `
                SELECT substr(date, 6, 5) AS day_key,
                       daily_total        AS sunspotCount
                FROM sunspots
                WHERE substr(date, 1, 4) = '${year}'
                  AND cast(substr(date, 6, 2) as integer) IN (${monthList})
                ORDER BY day_key ASC;
            `;
            const stmt = db.prepare(sqlQuery);
            const results = {};
            while (stmt.step()) {
                const row = stmt.getAsObject();
                results[row.day_key] = row.sunspotCount;
            }
            stmt.free();
            return results;
        }

        // --- Process Queried Data ---
        function processYearlyData(rows) {
            const data = {};
            rows.forEach(r => {
                data[r.day_key] = {
                    minTempF: parseFloat(r.minTempF),
                    maxTempF: parseFloat(r.maxTempF),
                    avgTempF: parseFloat(r.avgTempF),
                    maxCumGDD: parseFloat(r.maxCumGDD),
                    rainTotal: parseFloat(r.rainTotal)
                };
            });
            return data;
        }

        // --- Align Data to a Common X-axis ---
        function alignData(commonLabels, dataByDay, field) {
            return commonLabels.map(label => dataByDay[label] ? dataByDay[label][field] : null);
        }

        // --- Compute Bud Break Points Grouped by Variety ---
        function computeBudBreakPoints(selectedYears, commonLabels, yearlyData) {
            const result = db.exec("SELECT variety, heat_summation FROM grapevine_gdd ORDER BY variety");
            if (result.length === 0) return [];
            const grapeData = result[0].values;
            const budBreakByVariety = {};
            grapeData.forEach(row => {
                const variety = row[0];
                budBreakByVariety[variety] = [];
            });
            selectedYears.forEach(year => {
                const dataForYear = yearlyData[year];
                grapeData.forEach(row => {
                    const variety = row[0];
                    const threshold = row[1];
                    for (let i = 0; i < commonLabels.length; i++) {
                        const dayKey = commonLabels[i];
                        const record = dataForYear[dayKey];
                        if (record && record.maxCumGDD >= threshold) {
                            budBreakByVariety[variety].push({x: dayKey, y: record.maxCumGDD, year: year});
                            break;
                        }
                    }
                });
            });
            const scatterDatasets = [];
            Object.keys(budBreakByVariety).forEach(variety => {
                const points = budBreakByVariety[variety];
                if (points.length > 0) {
                    scatterDatasets.push({
                        label: variety,
                        data: points,
                        borderColor: getColorForVariety(variety),
                        backgroundColor: getColorForVariety(variety),
                        pointRadius: 6,
                        type: 'scatter',
                        showLine: false,
                        order: 2,
                        yAxisID: 'y1'
                    });
                }
            });
            return scatterDatasets;
        }

        // --- Function to Get Color for Variety ---
        function getColorForVariety(variety) {
            const grapeColors = {
                "Chardonnay": "rgb(255,140,0)",
                "Sauvignon Blanc": "rgb(255,215,0)",
                "Riesling": "rgb(255,69,0)",
                "Pinot Gris": "rgb(30,144,255)",
                "Semillon": "rgb(255,99,71)",
                "Cabernet Sauvignon": "rgb(139,0,0)",
                "Merlot": "rgb(220,20,60)",
                "Pinot Noir": "rgb(128,0,0)",
                "Syrah": "rgb(178,34,34)",
                "Zinfandel": "rgb(138,43,226)",
                "Sangiovese": "rgb(165,42,42)",
                "Tempranillo": "rgb(199,21,133)",
                "Malbec": "rgb(128,0,128)",
                "Grenache": "rgb(255,105,180)",
                "Nebbiolo": "rgb(75,0,130)"
            };
            if (grapeColors[variety]) {
                return grapeColors[variety];
            }
            const fallbackColors = [
                "rgb(255,0,0)",
                "rgb(0,255,0)",
                "rgb(0,0,255)",
                "rgb(255,255,0)",
                "rgb(255,0,255)",
                "rgb(0,255,255)"
            ];
            return fallbackColors[Math.floor(Math.random() * fallbackColors.length)];
        }

        // --- Random Color Generator (optional) ---
        function randomColor() {
            const r = Math.floor(Math.random() * 156) + 100;
            const g = Math.floor(Math.random() * 156) + 100;
            const b = Math.floor(Math.random() * 156) + 100;
            return `rgb(${r},${g},${b})`;
        }

        // --- Darken a given rgb color string by a given factor (0 to 1) ---
        function darkenColor(rgbStr, factor) {
            const result = /rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(rgbStr);
            if (!result) {
                return rgbStr;
            }
            let r = Math.floor(parseInt(result[1]) * factor);
            let g = Math.floor(parseInt(result[2]) * factor);
            let b = Math.floor(parseInt(result[3]) * factor);
            return `rgb(${r},${g},${b})`;
        }

        // --- Generate Custom Legend with Toggle on Click ---
        function generateCustomLegend(chart) {
            // Get the bottom legend container (for non–grape–varietal groups).
            const legendContainer = document.getElementById('legendContainer');
            legendContainer.innerHTML = '';

            // Get the container for grape varietals from the left panel.
            const grapeVarietalContainer = document.getElementById('grapeVarietalLegend');
            if (grapeVarietalContainer) grapeVarietalContainer.innerHTML = '';

            // Helper: Determine the legend category from the dataset label.
            function getLegendCategory(label) {
                if (label.includes("Min Temp") || label.includes("Max Temp")) return "Min/Max Temp";
                if (label.includes("Avg Temp")) return "Avg Temperature";
                if (label.includes("Cumulative GDD")) return "Cumulative GDD";
                if (label.includes("Daily Rain Total")) return "Daily Rain Totals";
                if (label.includes("Sunspots Daily Total")) return "Sunspot Daily Total";
                return "Grape Varietal";
            }

            // Group datasets by category. Skip any dataset flagged with hideInLegend.
            const groups = {};
            chart.data.datasets.forEach((ds, index) => {
                if (ds.hideInLegend) return;
                const cat = getLegendCategory(ds.label);
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push({ ds, index });
            });

            // Iterate over each group.
            Object.keys(groups).forEach(category => {
                if (category === "Grape Varietal") {
                    const header = document.createElement('div');
                    header.textContent = category;
                    header.style.fontWeight = 'bold';
                    header.style.marginTop = '10px';
                    header.style.textAlign = 'left';
                    grapeVarietalContainer.appendChild(header);

                    const groupDiv = document.createElement('div');
                    groupDiv.style.display = 'flex';
                    groupDiv.style.flexDirection = 'column';
                    groupDiv.style.gap = '8px';
                    groupDiv.style.justifyContent = 'flex-start';
                    groups[category].forEach(item => {
                        const { ds, index } = item;
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                        let markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:${ds.borderColor}; border-radius:50%; margin-right:5px;"></span>`;
                        legendItem.innerHTML = markerHTML + ds.label;
                        legendItem.style.cursor = 'pointer';
                        legendItem.onclick = function () {
                            if (chart.data.datasets[index].pairIndices) {
                                const indices = chart.data.datasets[index].pairIndices;
                                let newHidden = !chart.data.datasets[indices[0]].hidden;
                                indices.forEach(idx => {
                                    chart.data.datasets[idx].hidden = newHidden;
                                });
                                legendItem.style.opacity = newHidden ? 0.5 : 1;
                            } else {
                                chart.data.datasets[index].hidden = !chart.data.datasets[index].hidden;
                                legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                            }
                            chart.update();
                        };
                        groupDiv.appendChild(legendItem);
                    });
                    grapeVarietalContainer.appendChild(groupDiv);
                } else {
                    // For non–grape–varietal groups, create a group wrapper that will be arranged horizontally.
                    // Each group wrapper is a container with a header on top and legend items stacked vertically.
                    const groupWrapper = document.createElement('div');
                    groupWrapper.style.display = "inline-flex";
                    groupWrapper.style.flexDirection = "column";
                    groupWrapper.style.alignItems = "flex-start";
                    groupWrapper.style.marginRight = "15px";

                    const header = document.createElement('div');
                    header.textContent = category;
                    header.style.fontWeight = 'bold';
                    header.style.marginBottom = '5px';
                    header.style.textAlign = 'left';
                    groupWrapper.appendChild(header);

                    const groupDiv = document.createElement('div');
                    groupDiv.style.display = "flex";
                    groupDiv.style.flexDirection = "column";
                    groupDiv.style.gap = "8px";
                    groups[category].forEach(item => {
                        const { ds, index } = item;
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                        let markerHTML = "";
                        if (category === "Min/Max Temp" || category === "Avg Temperature") {
                            markerHTML = `<span style="display:inline-block; width:20px; border-bottom:2px solid ${ds.borderColor}; margin-right:5px;"></span>`;
                        } else if (category === "Cumulative GDD") {
                            markerHTML = `<span style="display:inline-block; width:20px; border-bottom:2px dashed ${ds.borderColor}; margin-right:5px;"></span>`;
                        } else if (category === "Daily Rain Totals") {
                            markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:${ds.backgroundColor}; margin-right:5px;"></span>`;
                        } else if (category === "Sunspot Daily Total") {
                            markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:purple; border-radius:50%; margin-right:5px;"></span>`;
                        }
                        legendItem.innerHTML = markerHTML + ds.label;
                        legendItem.style.cursor = 'pointer';
                        legendItem.onclick = function () {
                            if (chart.data.datasets[index].pairIndices) {
                                const indices = chart.data.datasets[index].pairIndices;
                                let newHidden = !chart.data.datasets[indices[0]].hidden;
                                indices.forEach(idx => {
                                    chart.data.datasets[idx].hidden = newHidden;
                                });
                                legendItem.style.opacity = newHidden ? 0.5 : 1;
                            } else {
                                chart.data.datasets[index].hidden = !chart.data.datasets[index].hidden;
                                legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                            }
                            chart.update();
                        };
                        groupDiv.appendChild(legendItem);
                    });
                    groupWrapper.appendChild(groupDiv);
                    legendContainer.appendChild(groupWrapper);
                }
            });
        }

        // --- Load and Plot Data Automatically (Overlay Years) ---
        function loadAndPlotData() {
            if (!db) return;
            const yearCheckboxes = document.querySelectorAll("input[name='year']:checked");
            const selectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
            const monthCheckboxes = document.querySelectorAll("input[name='month']:checked");
            const selectedMonths = Array.from(monthCheckboxes).map(cb => parseInt(cb.value));
            if (selectedYears.length === 0 || selectedMonths.length === 0) return;

            let commonLabelsSet = new Set();
            let yearlyData = {};
            selectedYears.forEach(year => {
                const rows = queryDataByYearAndMonths(year, selectedMonths);
                const data = processYearlyData(rows);
                yearlyData[year] = data;
                Object.keys(data).forEach(day_key => commonLabelsSet.add(day_key));
            });
            const commonLabels = Array.from(commonLabelsSet).sort();

            let datasets = [];
            selectedYears.forEach(year => {
                const dataForYear = yearlyData[year];
                const minTempData = alignData(commonLabels, dataForYear, "minTempF");
                const maxTempData = alignData(commonLabels, dataForYear, "maxTempF");
                const avgTempData = alignData(commonLabels, dataForYear, "avgTempF");
                const gddData     = alignData(commonLabels, dataForYear, "maxCumGDD");
                const rainData    = alignData(commonLabels, dataForYear, "rainTotal");

                const rawTempColor = randomColor();
                const bandFillColor = rawTempColor.replace("rgb(", "rgba(").replace(")", ",0.3)");
                const colorAvg = darkenColor(rawTempColor, 0.5);

                // Temperature band: combine min and max into one legend item.
                let indexMin = datasets.length;
                datasets.push({
                    label: `Min Temp (°F) - ${year}`,
                    data: minTempData,
                    borderColor: 'transparent',
                    backgroundColor: bandFillColor,
                    borderWidth: 0,
                    yAxisID: "y",
                    type: 'line',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 1,
                    hideInLegend: true
                });
                let indexMax = datasets.length;
                datasets.push({
                    label: `Min/Max Temp - ${year}`,
                    data: maxTempData,
                    borderColor: 'transparent',
                    backgroundColor: bandFillColor,
                    borderWidth: 0,
                    yAxisID: "y",
                    type: 'line',
                    fill: '-1',
                    tension: 0.4,
                    pointRadius: 0,
                    order: 2,
                    pairIndices: [indexMin, indexMax]
                });

                // Avg Temp dataset.
                datasets.push({
                    label: `Avg Temp (°F) - ${year}`,
                    data: avgTempData,
                    borderColor: colorAvg,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    yAxisID: "y",
                    type: 'line',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    order: 3
                });

                // Cumulative GDD dataset.
                datasets.push({
                    label: "Cumulative GDD - " + year,
                    data: gddData,
                    borderColor: randomColor(),
                    backgroundColor: 'transparent',
                    yAxisID: "y1",
                    tension: 0.4,
                    pointRadius: 2,
                    borderDash: [10, 5],
                    fill: false,
                    type: 'line',
                    order: 4
                });

                // Daily Rain dataset.
                datasets.push({
                    label: "Daily Rain Total (in) - " + year,
                    data: rainData,
                    backgroundColor: randomColor(),
                    yAxisID: "y2",
                    type: 'bar',
                    order: 5
                });
            });

            selectedYears.forEach(year => {
                const sunspotData = querySunspotsDataByYearAndMonths(year, selectedMonths);
                const sunspotsAligned = commonLabels.map(label => sunspotData[label] !== undefined ? sunspotData[label] : null);
                datasets.push({
                    label: "Sunspots Daily Total - " + year,
                    data: sunspotsAligned,
                    borderColor: "purple",
                    backgroundColor: "transparent",
                    yAxisID: "y3",
                    type: "line",
                    tension: 0.4,
                    pointRadius: 2,
                    borderWidth: 2,
                    order: 6
                });
            });

            const budBreakDatasets = computeBudBreakPoints(selectedYears, commonLabels, yearlyData);
            datasets = datasets.concat(budBreakDatasets);

            if (dailyChart) dailyChart.destroy();

            const ctx = document.getElementById('dailyChart').getContext('2d');
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: commonLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: "Daily Avg Temp (with Min/Max Band), Cumulative GDD, Daily Rain, Bud Break & Sunspots"
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "Month-Day"
                            }
                        },
                        y: {
                            position: "left",
                            title: {display: true, text: "Temperature (°F)"}
                        },
                        y1: {
                            position: "right",
                            title: {display: true, text: "Cumulative GDD"},
                            grid: {drawOnChartArea: false}
                        },
                        y2: {
                            position: "right",
                            title: {display: true, text: "Rain Total (in)"},
                            grid: {drawOnChartArea: false},
                            offset: true
                        },
                        y3: {
                            position: "right",
                            title: {display: true, text: "Sunspots Daily Total"},
                            grid: {drawOnChartArea: false},
                            offset: true
                        }
                    }
                }
            });

            generateCustomLegend(dailyChart);
        }

        // --- Generate Custom Legend with Toggle on Click ---
        function generateCustomLegend(chart) {
            // Get the bottom legend container (for non–grape–varietal groups).
            const legendContainer = document.getElementById('legendContainer');
            legendContainer.innerHTML = '';

            // Get the container for grape varietals from the left panel.
            const grapeVarietalContainer = document.getElementById('grapeVarietalLegend');
            if (grapeVarietalContainer) grapeVarietalContainer.innerHTML = '';

            // Helper: Determine the legend category from the dataset label.
            function getLegendCategory(label) {
                if (label.includes("Min Temp") || label.includes("Max Temp")) return "Min/Max Temp";
                if (label.includes("Avg Temp")) return "Avg Temperature";
                if (label.includes("Cumulative GDD")) return "Cumulative GDD";
                if (label.includes("Daily Rain Total")) return "Daily Rain Totals";
                if (label.includes("Sunspots Daily Total")) return "Sunspot Daily Total";
                return "Grape Varietal";
            }

            // Group datasets by category. Skip any dataset flagged with hideInLegend.
            const groups = {};
            chart.data.datasets.forEach((ds, index) => {
                if (ds.hideInLegend) return;
                const cat = getLegendCategory(ds.label);
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push({ ds, index });
            });

            // Iterate over each group.
            Object.keys(groups).forEach(category => {
                if (category === "Grape Varietal") {
                    const header = document.createElement('div');
                    header.textContent = category;
                    header.style.fontWeight = 'bold';
                    header.style.marginTop = '10px';
                    header.style.textAlign = 'left';
                    grapeVarietalContainer.appendChild(header);

                    const groupDiv = document.createElement('div');
                    groupDiv.style.display = 'flex';
                    groupDiv.style.flexDirection = 'column';
                    groupDiv.style.gap = '8px';
                    groupDiv.style.justifyContent = 'flex-start';
                    groups[category].forEach(item => {
                        const { ds, index } = item;
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                        let markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:${ds.borderColor}; border-radius:50%; margin-right:5px;"></span>`;
                        legendItem.innerHTML = markerHTML + ds.label;
                        legendItem.style.cursor = 'pointer';
                        legendItem.onclick = function () {
                            if (chart.data.datasets[index].pairIndices) {
                                const indices = chart.data.datasets[index].pairIndices;
                                let newHidden = !chart.data.datasets[indices[0]].hidden;
                                indices.forEach(idx => {
                                    chart.data.datasets[idx].hidden = newHidden;
                                });
                                legendItem.style.opacity = newHidden ? 0.5 : 1;
                            } else {
                                chart.data.datasets[index].hidden = !chart.data.datasets[index].hidden;
                                legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                            }
                            chart.update();
                        };
                        groupDiv.appendChild(legendItem);
                    });
                    grapeVarietalContainer.appendChild(groupDiv);
                } else {
                    // For non–grape–varietal groups, create a group wrapper that is arranged horizontally.
                    // Each group wrapper will be an inline-flex container with a header on top and its legend items stacked vertically.
                    const groupWrapper = document.createElement('div');
                    groupWrapper.style.display = "inline-flex";
                    groupWrapper.style.flexDirection = "column";
                    groupWrapper.style.alignItems = "flex-start";
                    groupWrapper.style.marginRight = "15px";

                    const header = document.createElement('div');
                    header.textContent = category;
                    header.style.fontWeight = 'bold';
                    header.style.marginBottom = '5px';
                    header.style.textAlign = 'left';
                    groupWrapper.appendChild(header);

                    const groupDiv = document.createElement('div');
                    groupDiv.style.display = "flex";
                    groupDiv.style.flexDirection = "column";
                    groupDiv.style.gap = "8px";
                    groups[category].forEach(item => {
                        const { ds, index } = item;
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                        let markerHTML = "";
                        if (category === "Min/Max Temp" || category === "Avg Temperature") {
                            markerHTML = `<span style="display:inline-block; width:20px; border-bottom:2px solid ${ds.borderColor}; margin-right:5px;"></span>`;
                        } else if (category === "Cumulative GDD") {
                            markerHTML = `<span style="display:inline-block; width:20px; border-bottom:2px dashed ${ds.borderColor}; margin-right:5px;"></span>`;
                        } else if (category === "Daily Rain Totals") {
                            markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:${ds.backgroundColor}; margin-right:5px;"></span>`;
                        } else if (category === "Sunspot Daily Total") {
                            markerHTML = `<span style="display:inline-block; width:12px; height:12px; background-color:purple; border-radius:50%; margin-right:5px;"></span>`;
                        }
                        legendItem.innerHTML = markerHTML + ds.label;
                        legendItem.style.cursor = 'pointer';
                        legendItem.onclick = function () {
                            if (chart.data.datasets[index].pairIndices) {
                                const indices = chart.data.datasets[index].pairIndices;
                                let newHidden = !chart.data.datasets[indices[0]].hidden;
                                indices.forEach(idx => {
                                    chart.data.datasets[idx].hidden = newHidden;
                                });
                                legendItem.style.opacity = newHidden ? 0.5 : 1;
                            } else {
                                chart.data.datasets[index].hidden = !chart.data.datasets[index].hidden;
                                legendItem.style.opacity = chart.data.datasets[index].hidden ? 0.5 : 1;
                            }
                            chart.update();
                        };
                        groupDiv.appendChild(legendItem);
                    });
                    groupWrapper.appendChild(groupDiv);
                    legendContainer.appendChild(groupWrapper);
                }
            });
        }

        // --- Load and Plot Data Automatically (Overlay Years) ---
        function loadAndPlotData() {
            if (!db) return;
            const yearCheckboxes = document.querySelectorAll("input[name='year']:checked");
            const selectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
            const monthCheckboxes = document.querySelectorAll("input[name='month']:checked");
            const selectedMonths = Array.from(monthCheckboxes).map(cb => parseInt(cb.value));
            if (selectedYears.length === 0 || selectedMonths.length === 0) return;

            let commonLabelsSet = new Set();
            let yearlyData = {};
            selectedYears.forEach(year => {
                const rows = queryDataByYearAndMonths(year, selectedMonths);
                const data = processYearlyData(rows);
                yearlyData[year] = data;
                Object.keys(data).forEach(day_key => commonLabelsSet.add(day_key));
            });
            const commonLabels = Array.from(commonLabelsSet).sort();

            let datasets = [];
            selectedYears.forEach(year => {
                const dataForYear = yearlyData[year];
                const minTempData = alignData(commonLabels, dataForYear, "minTempF");
                const maxTempData = alignData(commonLabels, dataForYear, "maxTempF");
                const avgTempData = alignData(commonLabels, dataForYear, "avgTempF");
                const gddData     = alignData(commonLabels, dataForYear, "maxCumGDD");
                const rainData    = alignData(commonLabels, dataForYear, "rainTotal");

                const rawTempColor = randomColor();
                const bandFillColor = rawTempColor.replace("rgb(", "rgba(").replace(")", ",0.3)");
                const colorAvg = darkenColor(rawTempColor, 0.5);

                // Temperature band: combine min and max.
                let indexMin = datasets.length;
                datasets.push({
                    label: `Min Temp (°F) - ${year}`,
                    data: minTempData,
                    borderColor: 'transparent',
                    backgroundColor: bandFillColor,
                    borderWidth: 0,
                    yAxisID: "y",
                    type: 'line',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 1,
                    hideInLegend: true
                });
                let indexMax = datasets.length;
                datasets.push({
                    label: `Min/Max Temp - ${year}`,
                    data: maxTempData,
                    borderColor: 'transparent',
                    backgroundColor: bandFillColor,
                    borderWidth: 0,
                    yAxisID: "y",
                    type: 'line',
                    fill: '-1',
                    tension: 0.4,
                    pointRadius: 0,
                    order: 2,
                    pairIndices: [indexMin, indexMax]
                });

                // Avg Temp dataset.
                datasets.push({
                    label: `Avg Temp (°F) - ${year}`,
                    data: avgTempData,
                    borderColor: colorAvg,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    yAxisID: "y",
                    type: 'line',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    order: 3
                });

                // Cumulative GDD dataset.
                datasets.push({
                    label: "Cumulative GDD - " + year,
                    data: gddData,
                    borderColor: randomColor(),
                    backgroundColor: 'transparent',
                    yAxisID: "y1",
                    tension: 0.4,
                    pointRadius: 2,
                    borderDash: [10, 5],
                    fill: false,
                    type: 'line',
                    order: 4
                });

                // Daily Rain dataset.
                datasets.push({
                    label: "Daily Rain Total (in) - " + year,
                    data: rainData,
                    backgroundColor: randomColor(),
                    yAxisID: "y2",
                    type: 'bar',
                    order: 5
                });
            });

            selectedYears.forEach(year => {
                const sunspotData = querySunspotsDataByYearAndMonths(year, selectedMonths);
                const sunspotsAligned = commonLabels.map(label => sunspotData[label] !== undefined ? sunspotData[label] : null);
                datasets.push({
                    label: "Sunspots Daily Total - " + year,
                    data: sunspotsAligned,
                    borderColor: "purple",
                    backgroundColor: "transparent",
                    yAxisID: "y3",
                    type: "line",
                    tension: 0.4,
                    pointRadius: 2,
                    borderWidth: 2,
                    order: 6
                });
            });

            const budBreakDatasets = computeBudBreakPoints(selectedYears, commonLabels, yearlyData);
            datasets = datasets.concat(budBreakDatasets);

            if (dailyChart) dailyChart.destroy();

            const ctx = document.getElementById('dailyChart').getContext('2d');
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: commonLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: "Daily Avg Temp (with Min/Max Band), Cumulative GDD, Daily Rain, Bud Break & Sunspots"
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "Month-Day"
                            }
                        },
                        y: {
                            position: "left",
                            title: {display: true, text: "Temperature (°F)"}
                        },
                        y1: {
                            position: "right",
                            title: {display: true, text: "Cumulative GDD"},
                            grid: {drawOnChartArea: false}
                        },
                        y2: {
                            position: "right",
                            title: {display: true, text: "Rain Total (in)"},
                            grid: {drawOnChartArea: false},
                            offset: true
                        },
                        y3: {
                            position: "right",
                            title: {display: true, text: "Sunspots Daily Total"},
                            grid: {drawOnChartArea: false},
                            offset: true
                        }
                    }
                }
            });

            generateCustomLegend(dailyChart);
        }

        // --- Slide-Out Panel Toggle Logic ---
        document.getElementById("toggleLeftPanel").addEventListener("click", function () {
            const leftPanel = document.getElementById("leftPanel");
            leftPanel.classList.toggle("hidden");
            setTimeout(() => window.dispatchEvent(new Event('resize')), 350);
        });
        document.getElementById("toggleRightPanel").addEventListener("click", function () {
            const rightPanel = document.getElementById("rightPanel");
            rightPanel.classList.toggle("hidden");
            setTimeout(() => window.dispatchEvent(new Event('resize')), 350);
        });
        window.addEventListener("resize", function () {
            if (dailyChart) dailyChart.resize();
        });

        window.onload = loadAndPlotData;
    </script>
</body>
</html>
